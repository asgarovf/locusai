# Learnings

This file captures important lessons, decisions, and corrections made during development.
It is read by AI agents before every task to avoid repeating mistakes and to follow established patterns.

<!-- Add learnings below this line. Format: - **[Category]**: Description -->
- **[Architecture]**: The VSCode extension invokes the CLI as `locus --json-stream --session-id <id> -- <prompt>`, where `--json-stream` is the first positional arg (argv[2]). The CLI's main() must detect this and route to `execCommand` since it's not a named subcommand. *The extension and CLI must agree on flag names (e.g., `--session-id` vs `--session`).*
- **[Debugging]**: The `@swc/helpers` package is not properly linked by Bun's package manager in this repo. The `jest.config.js` overrides `externalHelpers: false` in the SWC transform options to work around this. Without this override, all tests fail with "Cannot find module '@swc/helpers/_/_ts_decorate'".
- **[Patterns]**: Test files in `apps/api` use the `.jest.ts` extension (not `.spec.ts` or `.test.ts`). Always import `reflect-metadata` and `../../test-setup` at the top of test files before other imports. Entity mocks for TypeORM are defined in `apps/api/src/test-setup.ts`.
- **[Architecture]**: The CLI binary is `locus`, not `locus-agent` (`locus-agent` is the default OS username on provisioned servers). To upgrade the CLI on instances, run `sudo locus upgrade` — not `curl | bash`. The `locus upgrade` command handles npm cache cleaning, version checking, and `npm install -g` for all `@locusai/*` packages.
- **[DevOps]**: The `locus-telegram` process is managed differently per OS: on Linux it's a systemd service (`/etc/systemd/system/locus-telegram.service`, managed via `systemctl`), on macOS it's a LaunchAgent (`~/Library/LaunchAgents/com.locus.telegram.plist`, managed via `launchctl load/unload`).
- **[Debugging]**: Telegraf's `bot.launch()` must use `{ dropPendingUpdates: true }` to prevent re-processing old commands after a restart. Without this, commands like `/upgrade` that trigger a service restart will loop because the bot picks up the same `/upgrade` update from Telegram's queue on restart.
- **[Patterns]**: The CLI interactive REPL uses a custom raw-mode `InputHandler` (in `packages/cli/src/repl/input-handler.ts`) instead of `readline.createInterface`. This enables Shift+Enter for newlines, bracketed paste mode for multi-line paste, and input locking during agent execution. Any new interactive prompts should use `InputHandler` rather than `readline`.
- **[Debugging]**: In raw mode (`process.stdin.setRawMode(true)`), `OPOST` is disabled so `\n` in stdout is just LF (no carriage return). Always use `\r\n` for line breaks in terminal rendering. Also, ANSI color escape sequences (e.g., from `c.cyan()`) inflate `.length` but are invisible — use `str.replace(/\x1b\[[0-9;]*m/g, "")` to get visual width for terminal column calculations.
- **[Patterns]**: When aborting an AI runner process (`abort()`), set an `aborted` flag so the `close` handler can distinguish user-initiated interrupts from real errors. Without this, SIGTERM exits (code 143) produce confusing error messages like "CLI exited with code 143".
- **[Patterns]**: The CLI detects image file paths in user input (pasted screenshots, etc.) via `packages/cli/src/repl/image-detect.ts`. It handles macOS escaped-space paths (`Screenshot\ 2026-02-21.png`), unescaped paths, quoted paths, and `~/` expansion. Detected images are copied to a stable temp dir (`/tmp/locus-images/`) and the stable copy path is used in Read tool instructions, since macOS temp files can be deleted before Claude reads them.
- **[Debugging]**: Image path detection uses pattern-based detection (does NOT require `existsSync`). However, when a file DOES exist, it's copied to `/tmp/locus-images/` for stability. Read tool instructions are only included for files that exist (using the stable copy path). The `buildImageContext()` function filters to existing images only.
- **[DevOps]**: The CLI is bundled with `bun build` into a single `packages/cli/bin/locus.js` file. After modifying TypeScript source, always run `bun run build` in `packages/cli/` to rebuild. Running `tsc --noEmit` only type-checks — it does NOT produce the bundle. The bundle uses `__esm()` lazy initializers for module-scoped variables.
- **[Architecture]**: Shared command logic lives in `@locusai/commands` (`packages/commands/`). It exports: `SettingsManager` (settings load/save), artifact utilities (`listArtifacts`, `readArtifact`, `findArtifact`, `formatSize`, `formatDate`), config helpers (`resolveProvider`, `isProjectInitialized`, `maskSecret`), and `WorkspaceResolver`. CLI and Telegram import from this package instead of duplicating logic. Build order: shared → sdk → commands → cli, telegram.
- **[Patterns]**: The CLI's `settings-manager.ts` and `workspace-resolver.ts` are now thin re-exports/wrappers around `@locusai/commands`. CLI-specific versions add colored terminal output (e.g., `WorkspaceResolver` adds `c.dim()` logging). The shared `resolveProvider()` throws errors instead of calling `process.exit()` — CLI wraps it with a try/catch that exits.
- **[Architecture]**: Large files are split into focused modules with barrel re-exports for backward compatibility. CLI `config-manager.ts` → `templates.ts` (template strings) + `git-helpers.ts` (gitignore/identity). Telegram `command-whitelist.ts` → `input-parser.ts` (Unicode normalization + arg parsing). SDK `claude-runner.ts` → `claude-stream-parser.ts` (stream JSON parsing + tool tracking).
- **[Patterns]**: Logging is standardized via `LogFn` type and factory functions. SDK defines `LogFn`, `noopLogger`, and `createWorkerLogger` in `packages/sdk/src/ai/factory.ts`. `@locusai/commands` re-exports these and adds `createCliLogger()` (icon-based terminal output). CLI commands use `createCliLogger()` from `@locusai/commands`. Workers use `createWorkerLogger(agentId, prefix?)` for timestamped output. Never use inline `() => {}` as log fallback — use `noopLogger`. Never use `console.warn/log` directly in SDK runners — use `this.log?.(msg, level)`.
- **[Architecture]**: `@locusai/commands` now exports shared business logic beyond utilities: `resolveApiContext()` (API key → client + workspace resolution), `resolveAiSettings()` (provider + model merging), `listDiscussions/showDiscussion/archiveDiscussion/deleteDiscussion` (discussion CRUD), and `listPlans/showPlan/cancelPlan/rejectPlan` (plan lifecycle). CLI commands import these and wrap with terminal formatting. Telegram commands import these directly instead of shelling out to CLI and regex-parsing ANSI output. The shared functions throw errors — callers handle rendering.
- **[Patterns]**: Telegram plan commands (`/plans`, `/approve`, `/reject`, `/cancel`) now use `PlanManager` and shared functions directly instead of `CliExecutor`. This eliminates ANSI output parsing and provides structured data (plan IDs, task counts, statuses). Only `/plan <directive>` still shells out to CLI since the planning meeting is a long-running AI process. The callback handlers in `callbacks.ts` also use shared operations directly.