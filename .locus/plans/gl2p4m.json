{
  "id": "gl2p4m",
  "directive": "Create implementation plan from discussion: \"Docker has a great docs about sandboxing to support safely running the ai agents locally. I think we need to focus the security of locus from now on: https://docs.docker.com/ai/sandboxes/?_gl=1*futf2k*_gcl_au*MTM4MDEwNzAyOC4xNzcxNjkyNDA3*_ga*NTkwNzczNzQyLjE3NzE2OTI0MDc.*_ga_XJWPQMJYHQ*czE3NzIxNzAzNTkkbzQkZzEkdDE3NzIxNzAzNjEkajU4JGwwJGgw\"",
  "sprint": null,
  "createdAt": "2026-02-27T06:02:12.916Z",
  "issues": [
    {
      "order": 1,
      "title": "Add sandbox configuration to LocusConfig schema",
      "body": "## Summary\n\nExtend the `LocusConfig` type and default config to include a `sandbox` section that controls Docker sandbox behavior for AI agent execution.\n\n## Details\n\nAdd a new `SandboxConfig` interface to `packages/cli/src/types.ts`:\n\n```typescript\nexport interface SandboxConfig {\n  enabled: boolean;           // default: true — sandbox by default\n  extraWorkspaces: string[];  // additional workspace paths to sync into sandbox\n  readOnlyPaths: string[];    // paths mounted as read-only in sandbox\n}\n```\n\nAdd `sandbox: SandboxConfig` to the `LocusConfig` interface.\n\nUpdate `DEFAULT_CONFIG` in `packages/cli/src/core/config.ts`:\n```typescript\nsandbox: {\n  enabled: true,\n  extraWorkspaces: [],\n  readOnlyPaths: [],\n}\n```\n\nAdd a config migration so existing `.locus/config.json` files get the new `sandbox` section merged in on load.\n\n## Files to modify\n- `packages/cli/src/types.ts` — add `SandboxConfig` interface, add to `LocusConfig`\n- `packages/cli/src/core/config.ts` — add defaults, add migration\n\n## Acceptance Criteria\n- [ ] `SandboxConfig` interface is defined in `types.ts`\n- [ ] `LocusConfig` includes `sandbox: SandboxConfig`\n- [ ] `DEFAULT_CONFIG` includes sandbox defaults with `enabled: true`\n- [ ] Existing configs without `sandbox` key load correctly (migration applies defaults)\n- [ ] `locus config set sandbox.enabled false` works via `updateConfigValue`",
      "priority": "critical",
      "type": "feature",
      "dependsOn": "none"
    },
    {
      "order": 2,
      "title": "Implement Docker sandbox availability detection",
      "body": "## Summary\n\nCreate a utility module that detects whether Docker Desktop with sandbox support (4.58+) is available on the host system.\n\n## Details\n\nCreate `packages/cli/src/core/sandbox.ts` with:\n\n```typescript\nexport interface SandboxStatus {\n  available: boolean;\n  reason?: string;\n}\n\nexport async function detectSandboxSupport(): Promise<SandboxStatus>\n```\n\nDetection logic:\n1. Run `docker sandbox ls` with a 5-second timeout\n2. If it succeeds (exit code 0), return `{ available: true }`\n3. If it fails because `docker` is not found, return `{ available: false, reason: \"Docker is not installed\" }`\n4. If it fails because `sandbox` subcommand is not recognized, return `{ available: false, reason: \"Docker Desktop 4.58+ with sandbox support required\" }`\n5. If it times out, return `{ available: false, reason: \"Docker is not responding\" }`\n\nCache the result for the lifetime of the process (detection only needs to run once).\n\n## Files to create/modify\n- `packages/cli/src/core/sandbox.ts` — new file with detection logic\n\n## Acceptance Criteria\n- [ ] `detectSandboxSupport()` returns correct status when Docker sandbox is available\n- [ ] Returns meaningful reason string when Docker is missing or outdated\n- [ ] Result is cached after first call (no repeated subprocess spawns)\n- [ ] 5-second timeout prevents hanging if Docker daemon is unresponsive",
      "priority": "critical",
      "type": "feature",
      "dependsOn": "none"
    },
    {
      "order": 3,
      "title": "Add --no-sandbox and --sandbox=require CLI flags",
      "body": "## Summary\n\nAdd CLI flags to control sandbox behavior on the `locus run` command, allowing users to opt out of sandboxing or require it.\n\n## Details\n\n### Flag definitions\n\n| Flag | Behavior |\n|------|----------|\n| *(default)* | Use sandbox if available, warn and fall back to unsandboxed if not |\n| `--no-sandbox` | Explicitly disable sandboxing (show safety warning) |\n| `--sandbox=require` | Require sandbox — fail with error if Docker sandbox unavailable |\n\n### Implementation\n\n1. **`packages/cli/src/cli.ts`** — add `--no-sandbox` and `--sandbox` to `parseArgs()` flag parsing. `--sandbox` accepts a value (`require`).\n\n2. **`packages/cli/src/commands/run.ts`** — accept new flags in `runCommand` signature:\n   ```typescript\n   flags: { resume?: boolean; dryRun?: boolean; model?: string; sandbox?: string; noSandbox?: boolean }\n   ```\n\n3. **Resolve sandbox mode** — create a helper that combines config + flags into a final sandbox mode:\n   - `\"auto\"` (default) — sandbox if available, warn if not\n   - `\"disabled\"` — `--no-sandbox` or `config.sandbox.enabled === false`\n   - `\"required\"` — `--sandbox=require`\n\n   CLI flags override config values.\n\n## Files to modify\n- `packages/cli/src/cli.ts` — parse new flags, pass to `runCommand`\n- `packages/cli/src/commands/run.ts` — accept and resolve sandbox mode\n- `packages/cli/src/core/sandbox.ts` — add `resolveSandboxMode()` helper\n\n## Acceptance Criteria\n- [ ] `locus run 42 --no-sandbox` sets sandbox mode to disabled\n- [ ] `locus run 42 --sandbox=require` sets sandbox mode to required\n- [ ] `locus run 42` (no flag) defaults to auto mode\n- [ ] CLI flags override `config.sandbox.enabled`\n- [ ] `--sandbox=require` exits with error if Docker sandbox is unavailable\n- [ ] Invalid flag values produce a clear error message",
      "priority": "high",
      "type": "feature",
      "dependsOn": "1, 2"
    },
    {
      "order": 4,
      "title": "Create SandboxedClaudeRunner with Docker sandbox spawning",
      "body": "## Summary\n\nImplement a `SandboxedClaudeRunner` class that wraps Claude execution inside a Docker sandbox microVM, providing hypervisor-level isolation.\n\n## Details\n\nCreate a new runner class in `packages/cli/src/ai/claude-sandbox.ts` that implements the `AgentRunner` interface. It delegates to `docker sandbox run` instead of spawning `claude` directly.\n\n### Spawn change\n\n**Current** (`ClaudeRunner`):\n```typescript\nspawn(\"claude\", args, { cwd: options.cwd, stdio: [\"pipe\", \"pipe\", \"pipe\"], env })\n```\n\n**Sandboxed** (`SandboxedClaudeRunner`):\n```typescript\nconst sandboxName = `locus-${activityId}-${Date.now()}`;\nspawn(\"docker\", [\n  \"sandbox\", \"run\",\n  \"--name\", sandboxName,\n  \"claude\",\n  options.cwd,         // workspace path for Docker to sync\n  \"--\",                // separator\n  ...claudeArgs        // --print, --dangerously-skip-permissions, etc.\n], {\n  stdio: [\"pipe\", \"pipe\", \"pipe\"],\n  env: process.env,    // Docker proxy handles credential injection\n});\n```\n\n### Key design decisions\n- Reuse all Claude arg-building logic from `ClaudeRunner` (extract into shared helper or extend)\n- Store `sandboxName` as instance property for cleanup\n- `isAvailable()` should check both `claude` (inside sandbox) and `docker sandbox` availability\n- `getVersion()` can delegate to the existing `ClaudeRunner.getVersion()` since it just checks the host CLI\n- Stream parsing (NDJSON verbose mode) remains identical — stdout/stderr pipes work the same through Docker sandbox\n\n### Runner factory update\n\nUpdate `packages/cli/src/ai/runner.ts` to accept a `sandboxed` parameter:\n```typescript\nexport function createRunner(provider: AIProvider, sandboxed?: boolean): AgentRunner\n```\n\nWhen `sandboxed === true` and `provider === \"claude\"`, return `SandboxedClaudeRunner`.\n\n## Files to create/modify\n- `packages/cli/src/ai/claude-sandbox.ts` — new `SandboxedClaudeRunner` class\n- `packages/cli/src/ai/runner.ts` — update factory to support sandboxed runners\n- `packages/cli/src/ai/claude.ts` — extract shared arg-building logic if needed\n\n## Acceptance Criteria\n- [ ] `SandboxedClaudeRunner` implements the full `AgentRunner` interface\n- [ ] Process is spawned via `docker sandbox run` with correct arguments\n- [ ] Sandbox name follows pattern `locus-<activity>-<timestamp>`\n- [ ] Verbose/stream mode (NDJSON parsing) works correctly through Docker sandbox\n- [ ] `createRunner(\"claude\", true)` returns `SandboxedClaudeRunner`\n- [ ] `createRunner(\"claude\", false)` returns original `ClaudeRunner`\n- [ ] Stdin piping for prompt delivery works through Docker sandbox",
      "priority": "critical",
      "type": "feature",
      "dependsOn": "2"
    },
    {
      "order": 5,
      "title": "Implement sandbox lifecycle management (abort and cleanup)",
      "body": "## Summary\n\nImplement proper sandbox lifecycle management — ensuring sandboxes are always cleaned up on success, failure, or interrupt (SIGINT/SIGTERM).\n\n## Details\n\n### Abort mechanism\n\nReplace `process.kill(\"SIGTERM\")` with `docker sandbox rm` for sandboxed runners:\n\n```typescript\n// In SandboxedClaudeRunner\nabort(): void {\n  if (!this.sandboxName) return;\n  this.aborted = true;\n\n  // docker sandbox rm kills the VM and reclaims resources\n  try {\n    execSync(`docker sandbox rm ${this.sandboxName}`, { timeout: 10000 });\n  } catch {\n    // Sandbox may already be stopped — that's fine\n  }\n}\n```\n\n### Cleanup on normal exit\n\nAfter `execute()` resolves (success or error), ensure the sandbox is removed:\n\n```typescript\nasync execute(options: RunnerOptions): Promise<RunnerResult> {\n  try {\n    // ... spawn and wait for process ...\n    return result;\n  } finally {\n    this.cleanupSandbox();\n  }\n}\n\nprivate cleanupSandbox(): void {\n  if (this.sandboxName) {\n    try {\n      execSync(`docker sandbox rm ${this.sandboxName}`, { timeout: 10000 });\n    } catch { /* already removed */ }\n  }\n}\n```\n\n### Cleanup on process interrupt\n\nUpdate `packages/cli/src/core/shutdown.ts` to track active sandbox names and clean them up during shutdown:\n\n1. Add a registry: `registerActiveSandbox(name: string)` / `unregisterActiveSandbox(name: string)`\n2. In the shutdown handler, iterate active sandboxes and run `docker sandbox rm` for each\n3. This ensures sandboxes don't leak if the process is killed\n\n### Stale sandbox cleanup\n\nAdd a utility function (similar to `cleanupStaleWorktrees`) to find and remove orphaned `locus-*` sandboxes at startup:\n\n```typescript\nexport async function cleanupStaleSandboxes(): Promise<number> {\n  // docker sandbox ls, filter names starting with \"locus-\", rm each\n}\n```\n\n## Files to modify\n- `packages/cli/src/ai/claude-sandbox.ts` — abort and cleanup logic\n- `packages/cli/src/core/shutdown.ts` — sandbox registry and cleanup on interrupt\n- `packages/cli/src/core/sandbox.ts` — add `cleanupStaleSandboxes()`\n\n## Acceptance Criteria\n- [ ] `abort()` calls `docker sandbox rm` instead of `process.kill`\n- [ ] Sandbox is cleaned up in the `finally` block of `execute()`\n- [ ] Active sandboxes are tracked in a registry for shutdown handler access\n- [ ] Shutdown handler (SIGINT/SIGTERM) cleans up all active sandboxes\n- [ ] `cleanupStaleSandboxes()` removes orphaned `locus-*` sandboxes at startup\n- [ ] No sandbox leaks in any termination path (success, error, abort, signal)",
      "priority": "critical",
      "type": "feature",
      "dependsOn": "4"
    },
    {
      "order": 6,
      "title": "Wire sandbox into single-issue and sprint execution flows",
      "body": "## Summary\n\nIntegrate sandbox mode resolution into the main execution paths so that `locus run <issue>` and sprint runs use Docker sandboxes by default.\n\n## Details\n\n### Execution flow changes\n\n1. **`packages/cli/src/commands/run.ts`** — at the top of `runCommand`, resolve sandbox mode:\n   ```typescript\n   const sandboxMode = resolveSandboxMode(config.sandbox, flags);\n   if (sandboxMode !== \"disabled\") {\n     const status = await detectSandboxSupport();\n     if (!status.available) {\n       if (sandboxMode === \"required\") {\n         // Hard fail\n         error(`Docker sandbox required but not available: ${status.reason}`);\n         process.exit(1);\n       }\n       // Auto mode: warn and continue\n       warn(`Docker sandbox not available: ${status.reason}. Running unsandboxed.`);\n     }\n   }\n   ```\n\n2. **Pass sandbox flag through the execution chain**:\n   - `runCommand` → `executeIssue` → `runAgent` → `runAI` → `createRunner`\n   - Add `sandboxed: boolean` to `RunnerOptions` or `AgentOptions`\n   - `run-ai.ts` passes it to `createRunner(provider, sandboxed)`\n\n3. **`packages/cli/src/core/agent.ts`** — `executeIssue` receives and forwards the sandbox flag to `runAI`.\n\n4. **Sprint execution** — same sandbox resolution applies. Sprint runs should reuse sandbox detection result across all sequential tasks.\n\n5. **Stale sandbox cleanup** — call `cleanupStaleSandboxes()` alongside `cleanupStaleWorktrees()` at the start of run.\n\n## Files to modify\n- `packages/cli/src/commands/run.ts` — sandbox mode resolution and propagation\n- `packages/cli/src/core/agent.ts` — forward sandbox flag\n- `packages/cli/src/ai/run-ai.ts` — pass sandboxed to runner factory\n- `packages/cli/src/types.ts` — add `sandboxed?: boolean` to relevant options interfaces\n\n## Acceptance Criteria\n- [ ] `locus run 42` uses Docker sandbox when available (default behavior)\n- [ ] `locus run 42 --no-sandbox` runs without sandbox\n- [ ] `locus run 42 --sandbox=require` fails if Docker sandbox unavailable\n- [ ] Sprint runs use sandbox for each sequential task\n- [ ] Sandbox detection result is cached (not re-checked per task)\n- [ ] Stale sandboxes are cleaned up at the start of each run",
      "priority": "high",
      "type": "feature",
      "dependsOn": "3, 4, 5"
    },
    {
      "order": 7,
      "title": "Add sandbox support for parallel worktree execution",
      "body": "## Summary\n\nEnsure that parallel issue execution (multiple worktrees) creates one isolated Docker sandbox per worktree, providing full cross-agent isolation.\n\n## Details\n\n### Current parallel flow\n```\nlocus run 42 43 44\n  → createWorktree(42) → executeIssue(42, worktreePath)\n  → createWorktree(43) → executeIssue(43, worktreePath)\n  → createWorktree(44) → executeIssue(44, worktreePath)\n```\n\n### Proposed parallel flow with sandboxes\n```\nlocus run 42 43 44\n  → createWorktree(42) → docker sandbox \"locus-issue-42-<ts>\" → executeIssue(42)\n  → createWorktree(43) → docker sandbox \"locus-issue-43-<ts>\" → executeIssue(43)\n  → createWorktree(44) → docker sandbox \"locus-issue-44-<ts>\" → executeIssue(44)\n```\n\nEach sandbox gets its own:\n- Separate kernel (hypervisor isolation)\n- Synced workspace (the worktree path)\n- Private Docker daemon\n- Independent network proxy\n\n### Implementation\n\n1. **Sandbox naming** — use issue number in sandbox name for parallel runs: `locus-issue-<N>-<timestamp>`\n\n2. **`handleParallelRun`** in `run.ts` already passes `worktreePath` to `executeIssue`. The sandbox integration from issue #6 handles this — the sandbox runner receives `options.cwd` (the worktree path) and uses it as the workspace.\n\n3. **Cleanup on batch completion** — ensure `docker sandbox rm` runs for each sandbox even if some tasks in the batch fail. Use `Promise.allSettled` instead of `Promise.all` for the batch, then clean up.\n\n4. **Shutdown handler** — the sandbox registry from issue #5 handles interrupt cleanup for all parallel sandboxes.\n\n5. **Resource limits** — respect `config.agent.maxParallel` for sandbox count. Each sandbox is a microVM, so resource usage is higher than bare processes.\n\n## Files to modify\n- `packages/cli/src/commands/run.ts` — `handleParallelRun` to use `Promise.allSettled` and sandbox cleanup\n- `packages/cli/src/ai/claude-sandbox.ts` — sandbox naming convention for parallel runs\n\n## Acceptance Criteria\n- [ ] Each parallel issue gets its own Docker sandbox\n- [ ] Sandbox names include the issue number for easy identification\n- [ ] All sandboxes are cleaned up even if some tasks fail (use `Promise.allSettled`)\n- [ ] `maxParallel` config is respected for sandbox count\n- [ ] SIGINT/SIGTERM cleans up all active parallel sandboxes\n- [ ] Parallel sandboxes are fully isolated from each other (verified by separate workspace paths)",
      "priority": "high",
      "type": "feature",
      "dependsOn": "6"
    },
    {
      "order": 8,
      "title": "Show safety warning when running without sandbox",
      "body": "## Summary\n\nDisplay a clear warning to the user when AI agents run without Docker sandbox isolation, whether by explicit opt-out or because Docker sandbox is unavailable.\n\n## Details\n\n### Warning scenarios\n\n**1. Explicit opt-out (`--no-sandbox`)**:\n```\n⚠️  WARNING: Running without sandbox. The AI agent will have unrestricted\n   access to your filesystem, network, and environment variables.\n   Press Enter to continue or Ctrl+C to abort.\n```\nThis is an interactive confirmation — wait for Enter before proceeding. Skip the confirmation in non-interactive mode (piped stdin).\n\n**2. Auto mode, Docker unavailable**:\n```\n⚠️  Docker sandbox not available. Install Docker Desktop 4.58+ for secure execution.\n   Running without sandbox. Use --no-sandbox to suppress this warning.\n```\nThis is a non-blocking warning — print and continue.\n\n**3. Required mode, Docker unavailable**:\n```\n✖  Docker sandbox required but not available: Docker Desktop 4.58+ with sandbox support required.\n   Install Docker Desktop 4.58+ or remove --sandbox=require to continue.\n```\nThis is a fatal error — exit with code 1.\n\n### Implementation\n\nAdd a `displaySandboxWarning(mode, status)` function in `packages/cli/src/core/sandbox.ts` that handles all three cases. Use the existing terminal formatting utilities from `packages/cli/src/display/terminal.ts`.\n\nFor the interactive confirmation (case 1), use a simple readline prompt. Check `process.stdin.isTTY` to skip in non-interactive environments.\n\n## Files to modify\n- `packages/cli/src/core/sandbox.ts` — add `displaySandboxWarning()` function\n- `packages/cli/src/commands/run.ts` — call the warning function after sandbox mode resolution\n\n## Acceptance Criteria\n- [ ] `--no-sandbox` shows interactive warning requiring Enter to proceed\n- [ ] Auto mode with no Docker shows non-blocking warning and continues\n- [ ] `--sandbox=require` with no Docker exits with error code 1\n- [ ] Warning uses existing terminal color/formatting utilities\n- [ ] Interactive warning is skipped when stdin is not a TTY (CI/piped input)\n- [ ] Warning text clearly communicates the security implications",
      "priority": "medium",
      "type": "feature",
      "dependsOn": "3"
    },
    {
      "order": 9,
      "title": "Create SandboxedCodexRunner for Codex agent isolation",
      "body": "## Summary\n\nImplement a `SandboxedCodexRunner` class that wraps Codex execution inside a Docker sandbox, mirroring the pattern established by `SandboxedClaudeRunner`.\n\n## Details\n\nCreate `packages/cli/src/ai/codex-sandbox.ts` following the same pattern as `claude-sandbox.ts`.\n\n### Spawn change\n\n**Current** (`CodexRunner`):\n```typescript\nspawn(\"codex\", args, { cwd: options.cwd, stdio: [\"pipe\", \"pipe\", \"pipe\"], env })\n```\n\n**Sandboxed** (`SandboxedCodexRunner`):\n```typescript\nconst sandboxName = `locus-codex-${activityId}-${Date.now()}`;\nspawn(\"docker\", [\n  \"sandbox\", \"run\",\n  \"--name\", sandboxName,\n  \"codex\",\n  options.cwd,\n  \"--\",\n  ...codexArgs\n], {\n  stdio: [\"pipe\", \"pipe\", \"pipe\"],\n  env: process.env,\n});\n```\n\n### Notes\n- Docker sandbox support for Codex is expected but may not be available yet. This issue creates the runner class so it's ready when Docker adds support.\n- Reuse `buildCodexArgs()` from the existing `CodexRunner`.\n- JSONL event parsing remains identical — stdout pipes work through Docker sandbox.\n- Stdin piping for prompt delivery must work through the sandbox.\n- Update runner factory: `createRunner(\"codex\", true)` returns `SandboxedCodexRunner`.\n\n### Lifecycle\n- Same abort/cleanup pattern as `SandboxedClaudeRunner` — `docker sandbox rm` on abort, cleanup in `finally` block, register with sandbox registry.\n\n## Files to create/modify\n- `packages/cli/src/ai/codex-sandbox.ts` — new `SandboxedCodexRunner` class\n- `packages/cli/src/ai/runner.ts` — update factory for sandboxed Codex\n- `packages/cli/src/ai/codex.ts` — extract shared arg-building logic if needed\n\n## Acceptance Criteria\n- [ ] `SandboxedCodexRunner` implements the full `AgentRunner` interface\n- [ ] Process is spawned via `docker sandbox run` with correct Codex arguments\n- [ ] JSONL event parsing works through Docker sandbox stdout\n- [ ] Stdin prompt piping works through sandbox\n- [ ] `createRunner(\"codex\", true)` returns `SandboxedCodexRunner`\n- [ ] Abort and cleanup follow the same pattern as `SandboxedClaudeRunner`\n- [ ] Sandbox is registered with the shutdown handler registry",
      "priority": "medium",
      "type": "feature",
      "dependsOn": "5"
    },
    {
      "order": 10,
      "title": "Add sandbox documentation and migration guide",
      "body": "## Summary\n\nDocument the Docker sandbox integration for end users — covering setup requirements, configuration options, CLI flags, and troubleshooting.\n\n## Details\n\n### README updates\n\nAdd a \"Security & Sandboxing\" section to the main README covering:\n- What sandboxing provides (hypervisor isolation, separate kernel, credential protection)\n- Prerequisites: Docker Desktop 4.58+\n- Default behavior: sandboxed when Docker available\n- CLI flags: `--no-sandbox`, `--sandbox=require`\n- Configuration: `sandbox.enabled`, `sandbox.extraWorkspaces`, `sandbox.readOnlyPaths`\n\n### Configuration reference\n\nUpdate the configuration docs with the new `sandbox` config section:\n\n```json\n{\n  \"sandbox\": {\n    \"enabled\": true,\n    \"extraWorkspaces\": [\"/path/to/shared/libs\"],\n    \"readOnlyPaths\": [\"/path/to/configs\"]\n  }\n}\n```\n\n### Troubleshooting section\n\n- \"Docker sandbox not available\" — install/upgrade Docker Desktop\n- Sandbox performance — explain microVM overhead, resource usage with parallel runs\n- File sync delays — bidirectional sync may have slight latency\n- Network restrictions — outbound traffic goes through Docker proxy\n\n### CLI help text\n\nUpdate the help output for `locus run` to include sandbox flags in the usage information.\n\n## Files to modify\n- `README.md` or `docs/` — add Security & Sandboxing section\n- `packages/cli/src/cli.ts` — update help text for run command\n- `docs/` — configuration reference updates if separate docs exist\n\n## Acceptance Criteria\n- [ ] README has a clear Security & Sandboxing section\n- [ ] Docker Desktop prerequisite is documented\n- [ ] All sandbox CLI flags are documented with examples\n- [ ] Configuration options are documented with defaults\n- [ ] Troubleshooting covers common issues\n- [ ] `locus run --help` shows sandbox-related flags",
      "priority": "low",
      "type": "docs",
      "dependsOn": "6, 8"
    }
  ]
}